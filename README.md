# Emby Collections Cover Builder （Emby合集封面制作器）

## 工具概述

- 这是一个用于扫描媒体库并自动生成合集海报的脚本工具。通过分析视频文件的NFO元数据信息，识别属于同一合集的影片，然后创建专业的竖版2×2拼贴海报（400×600像素）。
- 最初开发的原因是Emby对于[JavSP](https://github.com/Yuukiy/JavSP/)刮削过的小姐姐电影合集时不时无法生成封面。
- 生成的collections文件夹可以直接覆盖到Emby目录下的programdata\metadata\collections，然后在合集中选择多个合集->右上角“...”->“刷新元数据”->打开“替换现有图像”->“刷新”，就可以看到新生成的合集封面了。

## 主要功能

1. **自动扫描媒体库** - 递归扫描指定目录下的视频文件
2. **NFO元数据解析** - 提取影片标题、年份、合集信息等
3. **智能海报查找** - 多种策略为每个视频查找对应的海报图片
4. **合集识别与分组** - 自动识别属于同一合集的影片
5. **专业海报生成** - 创建2×2竖版拼贴海报（400×600像素）
6. **CSV报告生成** - 输出详细的扫描结果（UTF-8-BOM编码，Excel友好）

## 使用方法

### 基本使用（GUI模式）

1. 直接运行脚本（无需参数）：
python main.py


2. 按照提示依次选择：
- 媒体库根目录（包含视频和NFO文件）
- 要处理的合集（仅显示包含2部及以上影片的合集）
- 输出根目录（结果将保存在此目录下的collections子文件夹中）

### 命令行模式
python main.py --root <媒体库路径> --out-dir <输出路径> --no-gui


可选参数：
- `--root`：指定媒体库根目录
- `--max-depth`：设置扫描深度（默认6级）
- `--out-dir`：指定输出目录
- `--log-dir`：指定日志目录
- `--no-gui`：禁用GUI界面（需同时提供--root和--out-dir参数）

## 生成结果说明

### 1. CSV报告文件

在输出目录的`collections/_csv/`子文件夹中生成两个CSV文件（无实质作用，可用于后期核验）：

- `set_rec.csv` - 原始扫描数据
- `set_rec_sort.csv` - 按合集名称、年份和标题排序的数据

CSV包含的列：
- path: NFO文件路径
- title: 影片标题
- year: 发行年份
- set_name: 合集名称
- id: 影片ID
- tmdbid: TMDB ID
- imdbid: IMDB ID
- poster_path: 找到的海报路径
- video_path: 视频文件路径

### 2. 合集海报

在输出目录的`collections/<合集名称>/`子文件夹中生成：

- `auto_poster_<合集名称>.jpg` - 2×2竖版拼贴海报（400×600像素）

**海报生成规则**：
- ≥4部影片：随机选择4张不同的海报
- 3部影片：随机选择3张，其中一张重复使用
- 2部影片：采用ABAB模式排列（A,B,A,B）
- <2部影片：单张海报重复使用4次

### 3. 日志文件

在日志目录中生成`set_rec.log`，记录详细处理过程和任何错误信息。

## 技术要求

- Python 3.6+
- 推荐安装Pillow库以获得最佳海报生成效果：
pip install pillow

- 如果没有Pillow，工具会回退到复制最大海报文件（尺寸不保证400×600）

## 注意事项

1. NFO文件支持：优先使用`<视频文件名>.nfo`，找不到时使用`movie.nfo`
2. 合集识别：支持`<set>`标签，优先提取`<name>`子标签内容
3. 海报查找策略（按优先级）：
 - 视频文件同名图片文件
 - 预设名称（poster.jpg, folder.jpg等）
 - 包含视频名称关键词的图片
 - 名称包含"poster"的图片
 - 目录中最大的图片文件
4. 非法文件名处理：自动替换非法字符为空格并压缩连续空格

## 适用场景

- 仅测试过Emby，Plex、Jellyfin、Kodi等媒体服务器应该可以使用，但无保证
- 批量整理媒体库中的系列影片
- 为电影合集创建统一的封面海报
- 媒体库元数据分析和导出




